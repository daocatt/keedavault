# å¤‡ä»½æ–‡ä»¶å­˜å‚¨æ–¹æ¡ˆåˆ†æ

## ğŸ“‹ å½“å‰æ–¹æ¡ˆ vs åº”ç”¨å†…å­˜å‚¨

### å½“å‰æ–¹æ¡ˆï¼šä¸æ•°æ®åº“åŒç›®å½•

**ä½ç½®**:
```
/Users/username/Documents/
â”œâ”€â”€ vault.kdbx                              (åŸæ–‡ä»¶)
â”œâ”€â”€ vault.backup.2025-12-12T19-00-00.kdbx  (å¤‡ä»½1)
â””â”€â”€ vault.backup.2025-12-12T18-55-00.kdbx  (å¤‡ä»½2)
```

**ä¼˜ç‚¹** âœ…:
1. **ç”¨æˆ·å¯è§** - ç”¨æˆ·å¯ä»¥ç›´æ¥åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­çœ‹åˆ°å¤‡ä»½
2. **æ˜“äºè®¿é—®** - å¯ä»¥ç›´æ¥å¤åˆ¶ã€ç§»åŠ¨æˆ–åˆ é™¤å¤‡ä»½
3. **è·¨åº”ç”¨å…¼å®¹** - å…¶ä»– KeePass åº”ç”¨ä¹Ÿèƒ½è¯†åˆ«å’Œä½¿ç”¨
4. **å¤‡ä»½éšæ•°æ®åº“ç§»åŠ¨** - ç§»åŠ¨æ•°æ®åº“æ—¶ï¼Œå¤‡ä»½ä¹Ÿä¸€èµ·ç§»åŠ¨
5. **æ— æƒé™é—®é¢˜** - ä¸æ•°æ®åº“æ–‡ä»¶æœ‰ç›¸åŒçš„è®¿é—®æƒé™
6. **æ˜“äºæ‰‹åŠ¨æ¢å¤** - ç›´æ¥é‡å‘½åå¤‡ä»½æ–‡ä»¶å³å¯æ¢å¤

**ç¼ºç‚¹** âŒ:
1. **æ–‡ä»¶å¤¹æ··ä¹±** - å¤šä¸ªå¤‡ä»½æ–‡ä»¶å¯èƒ½è®©æ–‡ä»¶å¤¹çœ‹èµ·æ¥æ‚ä¹±
2. **ç”¨æˆ·å¯èƒ½è¯¯åˆ ** - ç”¨æˆ·å¯èƒ½ä¸å°å¿ƒåˆ é™¤å¤‡ä»½æ–‡ä»¶
3. **å ç”¨ç”¨æˆ·ç©ºé—´** - ç›´æ¥å ç”¨ç”¨æˆ·æ–‡æ¡£ç›®å½•ç©ºé—´

---

### åº”ç”¨å†…å­˜å‚¨æ–¹æ¡ˆ

**ä½ç½®**:
```
macOS:
~/Library/Application Support/com.bsdev.keedavault/backups/
â”œâ”€â”€ vault-abc123.backup.2025-12-12T19-00-00.kdbx
â””â”€â”€ vault-abc123.backup.2025-12-12T18-55-00.kdbx

Windows:
C:\Users\username\AppData\Roaming\com.bsdev.keedavault\backups\

Linux:
~/.local/share/com.bsdev.keedavault/backups/
```

**ä¼˜ç‚¹** âœ…:
1. **æ–‡ä»¶å¤¹æ•´æ´** - ç”¨æˆ·æ–‡æ¡£ç›®å½•ä¿æŒå¹²å‡€
2. **é›†ä¸­ç®¡ç†** - æ‰€æœ‰æ•°æ®åº“çš„å¤‡ä»½é›†ä¸­åœ¨ä¸€ä¸ªä½ç½®
3. **ä¸æ˜“è¯¯åˆ ** - ç”¨æˆ·ä¸å¤ªå¯èƒ½æ„å¤–åˆ é™¤åº”ç”¨æ•°æ®
4. **ç»Ÿä¸€æ¸…ç†** - å¯ä»¥ä¸€æ¬¡æ€§æ¸…ç†æ‰€æœ‰å¤‡ä»½
5. **æ›´å¥½çš„ç»„ç»‡** - å¯ä»¥æŒ‰æ•°æ®åº“åˆ†ç»„ç®¡ç†å¤‡ä»½

**ç¼ºç‚¹** âŒ:
1. **ç”¨æˆ·ä¸å¯è§** - æ™®é€šç”¨æˆ·å¾ˆéš¾æ‰¾åˆ°å¤‡ä»½ä½ç½®
2. **æ¢å¤å¤æ‚** - éœ€è¦é€šè¿‡åº”ç”¨ UI æ‰èƒ½æ¢å¤
3. **è·¨åº”ç”¨ä¸å…¼å®¹** - å…¶ä»– KeePass åº”ç”¨æ‰¾ä¸åˆ°è¿™äº›å¤‡ä»½
4. **å¤‡ä»½åˆ†ç¦»** - ç§»åŠ¨æ•°æ®åº“æ—¶ï¼Œå¤‡ä»½ä¸ä¼šè·Ÿéš
5. **æƒé™å¤æ‚** - éœ€è¦é¢å¤–çš„æ–‡ä»¶ç³»ç»Ÿæƒé™é…ç½®
6. **å ç”¨ç³»ç»Ÿç©ºé—´** - å ç”¨åº”ç”¨æ•°æ®ç›®å½•ç©ºé—´

---

## ğŸ¯ æ¨èæ–¹æ¡ˆï¼šæ··åˆæ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šé»˜è®¤åŒç›®å½• + å¯é€‰åº”ç”¨å†…

**å®ç°**:
```typescript
interface BackupSettings {
    enabled: boolean;
    location: 'same-directory' | 'app-data';  // ç”¨æˆ·å¯é€‰
    maxBackups: number;
}
```

**é…ç½®ç•Œé¢**:
```
â”Œâ”€ Data Protection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                           â”‚
â”‚  ğŸ’¾ Auto Backup                      [ON] â”‚
â”‚  Automatically create backups before      â”‚
â”‚  saving (keeps 2 most recent backups)     â”‚
â”‚                                           â”‚
â”‚  ğŸ“ Backup Location:                      â”‚
â”‚     â—‹ Same as database (recommended)      â”‚
â”‚     â—‹ Application data folder             â”‚
â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜ç‚¹**:
- âœ… çµæ´»æ€§æœ€é«˜
- âœ… æ»¡è¶³ä¸åŒç”¨æˆ·éœ€æ±‚
- âœ… é»˜è®¤æ–¹æ¡ˆæœ€ç®€å•ï¼ˆåŒç›®å½•ï¼‰
- âœ… é«˜çº§ç”¨æˆ·å¯é€‰åº”ç”¨å†…å­˜å‚¨

---

### æ–¹æ¡ˆ Bï¼šæ™ºèƒ½å¤‡ä»½ä½ç½®

**é€»è¾‘**:
```typescript
function getBackupLocation(dbPath: string): string {
    // å¦‚æœæ•°æ®åº“åœ¨ç”¨æˆ·æ–‡æ¡£ç›®å½•
    if (isInDocumentsFolder(dbPath)) {
        return 'same-directory';  // åŒç›®å½•
    }
    
    // å¦‚æœæ•°æ®åº“åœ¨ä¸´æ—¶ä½ç½®æˆ–ç³»ç»Ÿç›®å½•
    if (isInTempOrSystemFolder(dbPath)) {
        return 'app-data';  // åº”ç”¨æ•°æ®ç›®å½•
    }
    
    // é»˜è®¤åŒç›®å½•
    return 'same-directory';
}
```

**ä¼˜ç‚¹**:
- âœ… è‡ªåŠ¨é€‰æ‹©æœ€ä½³ä½ç½®
- âœ… æ— éœ€ç”¨æˆ·é…ç½®
- âœ… æ™ºèƒ½å¤„ç†ç‰¹æ®Šæƒ…å†µ

---

## ğŸ’¡ æˆ‘çš„å»ºè®®

### ä¿æŒå½“å‰æ–¹æ¡ˆï¼ˆåŒç›®å½•å­˜å‚¨ï¼‰

**ç†ç”±**:

1. **ç¬¦åˆ KeePass ç”Ÿæ€ä¹ æƒ¯**
   - KeePassXCã€KeePass ç­‰éƒ½ä½¿ç”¨åŒç›®å½•å¤‡ä»½
   - ç”¨æˆ·æœŸæœ›å¤‡ä»½åœ¨æ•°æ®åº“æ—è¾¹

2. **ç®€å•ç›´è§‚**
   - ç”¨æˆ·å¯ä»¥ç›´æ¥çœ‹åˆ°å¤‡ä»½
   - æ‰‹åŠ¨æ¢å¤éå¸¸ç®€å•

3. **è·¨åº”ç”¨å…¼å®¹**
   - å…¶ä»– KeePass åº”ç”¨å¯ä»¥è¯†åˆ«
   - å¤‡ä»½æ–‡ä»¶å¯ä»¥åœ¨ä¸åŒåº”ç”¨é—´å…±äº«

4. **å¤‡ä»½éšæ•°æ®åº“ç§»åŠ¨**
   - ç§»åŠ¨æ•°æ®åº“åˆ° U ç›˜æ—¶ï¼Œå¤‡ä»½ä¹Ÿè·Ÿéš
   - é€‚åˆä¾¿æºä½¿ç”¨åœºæ™¯

5. **å®ç°ç®€å•**
   - å½“å‰å®ç°å·²ç»å¾ˆå®Œå–„
   - æ— éœ€é¢å¤–çš„æƒé™é…ç½®

### å¯é€‰çš„æ”¹è¿›

å¦‚æœç”¨æˆ·è§‰å¾—æ–‡ä»¶å¤¹æ··ä¹±ï¼Œå¯ä»¥ï¼š

#### æ”¹è¿› 1ï¼šä½¿ç”¨å­æ–‡ä»¶å¤¹

```
/Users/username/Documents/
â”œâ”€â”€ vault.kdbx
â””â”€â”€ .vault.backups/  (éšè—æ–‡ä»¶å¤¹)
    â”œâ”€â”€ vault.backup.2025-12-12T19-00-00.kdbx
    â””â”€â”€ vault.backup.2025-12-12T18-55-00.kdbx
```

**ä¼˜ç‚¹**:
- âœ… æ–‡ä»¶å¤¹æ•´æ´
- âœ… å¤‡ä»½ä»åœ¨åŒä¸€ä½ç½®
- âœ… éšè—æ–‡ä»¶å¤¹ä¸å½±å“è§†è§‰

**å®ç°**:
```typescript
function getBackupPath(originalPath: string): string {
    const dir = path.dirname(originalPath);
    const filename = path.basename(originalPath);
    const backupDir = path.join(dir, `.${filename}.backups`);
    
    // åˆ›å»ºå¤‡ä»½ç›®å½•
    await mkdir(backupDir, { recursive: true });
    
    return path.join(backupDir, `${filename}.backup.${timestamp}.kdbx`);
}
```

#### æ”¹è¿› 2ï¼šæ·»åŠ  .gitignore é£æ ¼çš„éšè—

```
vault.kdbx
.vault.backup.2025-12-12T19-00-00.kdbx  (éšè—æ–‡ä»¶)
.vault.backup.2025-12-12T18-55-00.kdbx  (éšè—æ–‡ä»¶)
```

**ä¼˜ç‚¹**:
- âœ… åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­é»˜è®¤éšè—
- âœ… ä»åœ¨åŒä¸€ç›®å½•
- âœ… é«˜çº§ç”¨æˆ·å¯ä»¥æ˜¾ç¤ºéšè—æ–‡ä»¶æŸ¥çœ‹

**å®ç°**:
```typescript
function getBackupPath(originalPath: string): string {
    const dir = path.dirname(originalPath);
    const filename = path.basename(originalPath);
    
    // åœ¨æ–‡ä»¶åå‰åŠ ç‚¹ï¼Œä½¿å…¶æˆä¸ºéšè—æ–‡ä»¶
    return path.join(dir, `.${filename}.backup.${timestamp}.kdbx`);
}
```

---

## ğŸ” åº”ç”¨å†…å­˜å‚¨çš„å®ç°å‚è€ƒ

å¦‚æœçœŸçš„è¦å®ç°åº”ç”¨å†…å­˜å‚¨ï¼Œè¿™æ˜¯å®ç°æ–¹å¼ï¼š

### 1. è·å–åº”ç”¨æ•°æ®ç›®å½•

```typescript
import { appDataDir } from '@tauri-apps/api/path';

async function getBackupDirectory(): Promise<string> {
    const appData = await appDataDir();
    const backupDir = path.join(appData, 'backups');
    
    // ç¡®ä¿ç›®å½•å­˜åœ¨
    await mkdir(backupDir, { recursive: true });
    
    return backupDir;
}
```

### 2. ç”Ÿæˆå¤‡ä»½æ–‡ä»¶å

```typescript
async function getAppDataBackupPath(originalPath: string): Promise<string> {
    const backupDir = await getBackupDirectory();
    
    // ä½¿ç”¨æ•°æ®åº“è·¯å¾„çš„å“ˆå¸Œä½œä¸ºæ ‡è¯†
    const dbHash = hashPath(originalPath);
    const timestamp = formatTimestamp(new Date());
    
    return path.join(
        backupDir,
        `${dbHash}.backup.${timestamp}.kdbx`
    );
}

function hashPath(path: string): string {
    // ç®€å•çš„å“ˆå¸Œï¼Œå®é™…å¯ä»¥ç”¨ crypto
    return Buffer.from(path).toString('base64')
        .replace(/[/+=]/g, '')
        .substring(0, 16);
}
```

### 3. å¤‡ä»½å…ƒæ•°æ®

```typescript
// ä¿å­˜å¤‡ä»½å…ƒæ•°æ®ï¼Œæ–¹ä¾¿æŸ¥æ‰¾
interface BackupMetadata {
    originalPath: string;
    backupPath: string;
    timestamp: Date;
    size: number;
}

async function saveBackupMetadata(metadata: BackupMetadata) {
    const metadataPath = path.join(
        await getBackupDirectory(),
        'metadata.json'
    );
    
    const existing = await loadMetadata();
    existing.push(metadata);
    
    await writeFile(metadataPath, JSON.stringify(existing, null, 2));
}
```

### 4. åˆ—å‡ºå¤‡ä»½

```typescript
async function listBackupsForDatabase(dbPath: string): Promise<BackupMetadata[]> {
    const metadata = await loadMetadata();
    return metadata.filter(m => m.originalPath === dbPath);
}
```

### 5. æ¸…ç†å¤‡ä»½

```typescript
async function cleanupAppDataBackups(dbPath: string, maxBackups: number) {
    const backups = await listBackupsForDatabase(dbPath);
    
    // æŒ‰æ—¶é—´æ’åº
    backups.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
    
    // åˆ é™¤è¶…è¿‡é™åˆ¶çš„å¤‡ä»½
    const toDelete = backups.slice(maxBackups);
    for (const backup of toDelete) {
        await remove(backup.backupPath);
    }
    
    // æ›´æ–°å…ƒæ•°æ®
    await updateMetadata(backups.slice(0, maxBackups));
}
```

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“

| ç‰¹æ€§ | åŒç›®å½• | åº”ç”¨å†… | å­æ–‡ä»¶å¤¹ | éšè—æ–‡ä»¶ |
|------|--------|--------|---------|---------|
| ç”¨æˆ·å¯è§ | âœ… | âŒ | âš ï¸ | âš ï¸ |
| æ–‡ä»¶å¤¹æ•´æ´ | âŒ | âœ… | âœ… | âœ… |
| æ˜“äºæ¢å¤ | âœ… | âŒ | âœ… | âœ… |
| è·¨åº”ç”¨å…¼å®¹ | âœ… | âŒ | âœ… | âœ… |
| å®ç°å¤æ‚åº¦ | âœ… ç®€å• | âŒ å¤æ‚ | âš ï¸ ä¸­ç­‰ | âœ… ç®€å• |
| æƒé™é—®é¢˜ | âœ… æ—  | âš ï¸ éœ€è¦ | âœ… æ—  | âœ… æ—  |

---

## ğŸ¯ æœ€ç»ˆå»ºè®®

### çŸ­æœŸï¼ˆå½“å‰ç‰ˆæœ¬ï¼‰

**ä¿æŒåŒç›®å½•å­˜å‚¨**ï¼Œå› ä¸ºï¼š
- âœ… ç¬¦åˆ KeePass ç”Ÿæ€
- âœ… å®ç°ç®€å•ç¨³å®š
- âœ… ç”¨æˆ·ä¹ æƒ¯

### ä¸­æœŸï¼ˆä¸‹ä¸€ç‰ˆæœ¬ï¼‰

**æ·»åŠ éšè—æ–‡ä»¶é€‰é¡¹**ï¼š
```typescript
// åœ¨è®¾ç½®ä¸­æ·»åŠ 
hideBackupFiles: boolean;  // é»˜è®¤ false
```

å¦‚æœå¯ç”¨ï¼Œå¤‡ä»½æ–‡ä»¶åå‰åŠ ç‚¹ï¼š
```
.vault.backup.2025-12-12T19-00-00.kdbx
```

### é•¿æœŸï¼ˆæœªæ¥ç‰ˆæœ¬ï¼‰

**æä¾›å¤šç§å¤‡ä»½ä½ç½®é€‰é¡¹**ï¼š
1. åŒç›®å½•ï¼ˆé»˜è®¤ï¼‰
2. åŒç›®å½•å­æ–‡ä»¶å¤¹
3. åº”ç”¨æ•°æ®ç›®å½•
4. è‡ªå®šä¹‰ä½ç½®

è®©ç”¨æˆ·æ ¹æ®éœ€æ±‚é€‰æ‹©ã€‚

---

## âœ… ç»“è®º

**å»ºè®®ä¿æŒå½“å‰çš„åŒç›®å½•å­˜å‚¨æ–¹æ¡ˆ**ï¼ŒåŸå› ï¼š

1. ç¬¦åˆ KeePass ç”Ÿæ€æ ‡å‡†
2. ç”¨æˆ·ä½“éªŒæœ€å¥½
3. å®ç°æœ€ç®€å•
4. è·¨åº”ç”¨å…¼å®¹æ€§æœ€ä½³

å¦‚æœéœ€è¦æ”¹è¿›ï¼Œä¼˜å…ˆè€ƒè™‘ï¼š
- ä½¿ç”¨éšè—æ–‡ä»¶ï¼ˆåŠ ç‚¹å‰ç¼€ï¼‰
- æˆ–ä½¿ç”¨å­æ–‡ä»¶å¤¹

**ä¸å»ºè®®**ä½¿ç”¨åº”ç”¨å†…å­˜å‚¨ï¼Œé™¤éï¼š
- ç”¨æˆ·æ˜ç¡®è¦æ±‚
- æä¾›ä¸ºå¯é€‰åŠŸèƒ½
- æœ‰å®Œå–„çš„ UI æ”¯æŒå¤‡ä»½ç®¡ç†
